# データベース設計書

## 1. 概要

### 1.1 目的
本ドキュメントは、システム設計アシスタントのデータベース設計について詳細に定義する。

### 1.2 対象システム
- **データベース**: Supabase (PostgreSQL)
- **認証**: Supabase Auth
- **リアルタイム**: Supabase Realtime
- **ストレージ**: Supabase Storage

### 1.3 設計方針
- **正規化**: 第3正規形まで適用
- **セキュリティ**: Row Level Security (RLS) を全テーブルに適用
- **パフォーマンス**: 適切なインデックス設計
- **整合性**: 外部キー制約とトリガーによる整合性保証

## 2. ER図

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│     users       │    │   projects       │    │ project_members │
├─────────────────┤    ├──────────────────┤    ├─────────────────┤
│ id (PK)         │    │ id (PK)          │    │ id (PK)         │
│ email           │    │ name             │    │ project_id (FK) │
│ created_at      │    │ description      │    │ user_id (FK)    │
│ updated_at      │    │ created_by (FK)  │    │ role            │
└─────────────────┘    │ created_at       │    │ created_at      │
                       │ updated_at       │    │ updated_at      │
                       └──────────────────┘    └─────────────────┘
                                │                        │
                                │                        │
                                ▼                        ▼
                       ┌──────────────────┐    ┌─────────────────┐
                       │ project_invitations │    │     tasks      │
                       ├──────────────────┤    ├─────────────────┤
                       │ id (PK)          │    │ id (PK)         │
                       │ project_id (FK)  │    │ project_id (FK) │
                       │ email            │    │ title           │
                       │ role             │    │ description     │
                       │ status           │    │ status          │
                       │ created_at       │    │ assigned_to     │
                       │ updated_at       │    │ created_at      │
                       └──────────────────┘    │ updated_at      │
                                               └─────────────────┘
                                                        │
                                                        │
                                                        ▼
                                               ┌─────────────────┐
                                               │  deliverables   │
                                               ├─────────────────┤
                                               │ id (PK)         │
                                               │ project_id (FK) │
                                               │ name            │
                                               │ description     │
                                               │ status          │
                                               │ due_date        │
                                               │ created_at      │
                                               │ updated_at      │
                                               └─────────────────┘
```

## 3. テーブル定義

### 3.1 users テーブル

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email TEXT UNIQUE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);

-- RLS ポリシー
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own data" ON users
    FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can update their own data" ON users
    FOR UPDATE USING (auth.uid() = id);
```

### 3.2 projects テーブル

```sql
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    description TEXT,
    created_by UUID REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_projects_created_by ON projects(created_by);
CREATE INDEX idx_projects_created_at ON projects(created_at);

-- RLS ポリシー
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Project members can view projects" ON projects
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM project_members 
            WHERE project_id = projects.id 
            AND user_id = auth.uid()
        )
    );

CREATE POLICY "Project creators can update projects" ON projects
    FOR UPDATE USING (created_by = auth.uid());

CREATE POLICY "Authenticated users can create projects" ON projects
    FOR INSERT WITH CHECK (auth.uid() = created_by);
```

### 3.3 project_members テーブル

```sql
CREATE TABLE project_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'member')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(project_id, user_id)
);

-- インデックス
CREATE INDEX idx_project_members_project_id ON project_members(project_id);
CREATE INDEX idx_project_members_user_id ON project_members(user_id);
CREATE INDEX idx_project_members_role ON project_members(role);

-- RLS ポリシー
ALTER TABLE project_members ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Project members can view project members" ON project_members
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM project_members pm
            WHERE pm.project_id = project_members.project_id
            AND pm.user_id = auth.uid()
        )
    );

CREATE POLICY "Project owners can manage members" ON project_members
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM project_members pm
            WHERE pm.project_id = project_members.project_id
            AND pm.user_id = auth.uid()
            AND pm.role IN ('owner', 'admin')
        )
    );
```

### 3.4 project_invitations テーブル

```sql
CREATE TABLE project_invitations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    email TEXT NOT NULL,
    role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('admin', 'member')),
    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'declined')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_project_invitations_project_id ON project_invitations(project_id);
CREATE INDEX idx_project_invitations_email ON project_invitations(email);
CREATE INDEX idx_project_invitations_status ON project_invitations(status);

-- RLS ポリシー
ALTER TABLE project_invitations ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Project members can view invitations" ON project_invitations
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM project_members
            WHERE project_id = project_invitations.project_id
            AND user_id = auth.uid()
        )
    );

CREATE POLICY "Project owners can manage invitations" ON project_invitations
    FOR ALL USING (
        EXISTS (
            SELECT 1 FROM project_members
            WHERE project_id = project_invitations.project_id
            AND user_id = auth.uid()
            AND role IN ('owner', 'admin')
        )
    );
```

### 3.5 tasks テーブル

```sql
CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    status TEXT NOT NULL DEFAULT 'todo' CHECK (status IN ('todo', 'in_progress', 'done')),
    assigned_to UUID REFERENCES users(id) ON DELETE SET NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_tasks_project_id ON tasks(project_id);
CREATE INDEX idx_tasks_assigned_to ON tasks(assigned_to);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_created_at ON tasks(created_at);

-- RLS ポリシー
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Project members can view tasks" ON tasks
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM project_members
            WHERE project_id = tasks.project_id
            AND user_id = auth.uid()
        )
    );

CREATE POLICY "Project members can update tasks" ON tasks
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM project_members
            WHERE project_id = tasks.project_id
            AND user_id = auth.uid()
        )
    );

CREATE POLICY "Project members can create tasks" ON tasks
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM project_members
            WHERE project_id = tasks.project_id
            AND user_id = auth.uid()
        )
    );
```

### 3.6 deliverables テーブル

```sql
CREATE TABLE deliverables (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    description TEXT,
    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed')),
    due_date DATE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- インデックス
CREATE INDEX idx_deliverables_project_id ON deliverables(project_id);
CREATE INDEX idx_deliverables_status ON deliverables(status);
CREATE INDEX idx_deliverables_due_date ON deliverables(due_date);

-- RLS ポリシー
ALTER TABLE deliverables ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Project members can view deliverables" ON deliverables
    FOR SELECT USING (
        EXISTS (
            SELECT 1 FROM project_members
            WHERE project_id = deliverables.project_id
            AND user_id = auth.uid()
        )
    );

CREATE POLICY "Project members can update deliverables" ON deliverables
    FOR UPDATE USING (
        EXISTS (
            SELECT 1 FROM project_members
            WHERE project_id = deliverables.project_id
            AND user_id = auth.uid()
        )
    );

CREATE POLICY "Project members can create deliverables" ON deliverables
    FOR INSERT WITH CHECK (
        EXISTS (
            SELECT 1 FROM project_members
            WHERE project_id = deliverables.project_id
            AND user_id = auth.uid()
        )
    );
```

## 4. トリガーとストアドプロシージャ

### 4.1 updated_at 自動更新トリガー

```sql
-- updated_at を自動更新する関数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- 各テーブルにトリガーを設定
CREATE TRIGGER update_projects_updated_at 
    BEFORE UPDATE ON projects 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_project_members_updated_at 
    BEFORE UPDATE ON project_members 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_project_invitations_updated_at 
    BEFORE UPDATE ON project_invitations 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_tasks_updated_at 
    BEFORE UPDATE ON tasks 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_deliverables_updated_at 
    BEFORE UPDATE ON deliverables 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 4.2 プロジェクト作成時の自動メンバー追加

```sql
-- プロジェクト作成時に作成者を自動的にメンバーに追加
CREATE OR REPLACE FUNCTION add_project_creator_as_member()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO project_members (project_id, user_id, role)
    VALUES (NEW.id, NEW.created_by, 'owner');
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER add_project_creator_as_member_trigger
    AFTER INSERT ON projects
    FOR EACH ROW EXECUTE FUNCTION add_project_creator_as_member();
```

### 4.3 招待受け入れ時の自動メンバー追加

```sql
-- 招待を受け入れた時に自動的にメンバーに追加
CREATE OR REPLACE FUNCTION accept_invitation_and_add_member()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.status = 'accepted' AND OLD.status = 'pending' THEN
        INSERT INTO project_members (project_id, user_id, role)
        VALUES (NEW.project_id, auth.uid(), NEW.role);
    END IF;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER accept_invitation_trigger
    AFTER UPDATE ON project_invitations
    FOR EACH ROW EXECUTE FUNCTION accept_invitation_and_add_member();
```

## 5. ビュー

### 5.1 プロジェクト概要ビュー

```sql
CREATE VIEW project_overview AS
SELECT 
    p.id,
    p.name,
    p.description,
    p.created_at,
    COUNT(DISTINCT pm.user_id) as member_count,
    COUNT(DISTINCT t.id) as task_count,
    COUNT(DISTINCT d.id) as deliverable_count,
    COUNT(DISTINCT CASE WHEN t.status = 'done' THEN t.id END) as completed_tasks,
    COUNT(DISTINCT CASE WHEN d.status = 'completed' THEN d.id END) as completed_deliverables
FROM projects p
LEFT JOIN project_members pm ON p.id = pm.project_id
LEFT JOIN tasks t ON p.id = t.project_id
LEFT JOIN deliverables d ON p.id = d.project_id
GROUP BY p.id, p.name, p.description, p.created_at;
```

### 5.2 ユーザー権限ビュー

```sql
CREATE VIEW user_permissions AS
SELECT 
    u.id as user_id,
    u.email,
    p.id as project_id,
    p.name as project_name,
    pm.role as user_role,
    CASE 
        WHEN pm.role = 'owner' THEN true
        WHEN pm.role = 'admin' THEN true
        ELSE false
    END as can_manage_members,
    CASE 
        WHEN pm.role = 'owner' THEN true
        ELSE false
    END as can_delete_project
FROM users u
JOIN project_members pm ON u.id = pm.user_id
JOIN projects p ON pm.project_id = p.id;
```

## 6. インデックス戦略

### 6.1 パフォーマンス最適化インデックス

```sql
-- 複合インデックス（プロジェクト内での検索最適化）
CREATE INDEX idx_tasks_project_status ON tasks(project_id, status);
CREATE INDEX idx_deliverables_project_status ON deliverables(project_id, status);

-- 日付範囲検索用インデックス
CREATE INDEX idx_deliverables_due_date_status ON deliverables(due_date, status);

-- ユーザー別タスク検索用インデックス
CREATE INDEX idx_tasks_assigned_to_status ON tasks(assigned_to, status);

-- 招待メール検索用インデックス
CREATE INDEX idx_invitations_email_status ON project_invitations(email, status);
```

### 6.2 全文検索インデックス

```sql
-- プロジェクト名と説明の全文検索
CREATE INDEX idx_projects_search ON projects USING gin(to_tsvector('japanese', name || ' ' || COALESCE(description, '')));

-- タスクの全文検索
CREATE INDEX idx_tasks_search ON tasks USING gin(to_tsvector('japanese', title || ' ' || COALESCE(description, '')));
```

## 7. バックアップ戦略

### 7.1 自動バックアップ設定

```sql
-- 日次バックアップ（Supabase管理）
-- ポイントインタイムリカバリ（PITR）有効
-- 7日間の保持期間
```

### 7.2 データエクスポート

```sql
-- プロジェクトデータエクスポート用ビュー
CREATE VIEW project_export AS
SELECT 
    p.id as project_id,
    p.name as project_name,
    p.description as project_description,
    p.created_at as project_created_at,
    u.email as creator_email,
    pm.role as member_role,
    t.title as task_title,
    t.status as task_status,
    d.name as deliverable_name,
    d.status as deliverable_status,
    d.due_date as deliverable_due_date
FROM projects p
LEFT JOIN users u ON p.created_by = u.id
LEFT JOIN project_members pm ON p.id = pm.project_id
LEFT JOIN users um ON pm.user_id = um.id
LEFT JOIN tasks t ON p.id = t.project_id
LEFT JOIN deliverables d ON p.id = d.project_id;
```

## 8. 監視とメトリクス

### 8.1 パフォーマンス監視クエリ

```sql
-- テーブルサイズ監視
SELECT 
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation
FROM pg_stats 
WHERE schemaname = 'public'
ORDER BY tablename, attname;

-- インデックス使用状況監視
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

### 8.2 アクティビティ監視

```sql
-- 最近のアクティビティ監視
SELECT 
    p.name as project_name,
    COUNT(t.id) as recent_tasks,
    COUNT(d.id) as recent_deliverables,
    MAX(GREATEST(t.updated_at, d.updated_at)) as last_activity
FROM projects p
LEFT JOIN tasks t ON p.id = t.project_id AND t.updated_at > NOW() - INTERVAL '7 days'
LEFT JOIN deliverables d ON p.id = d.project_id AND d.updated_at > NOW() - INTERVAL '7 days'
GROUP BY p.id, p.name
ORDER BY last_activity DESC;
```

## 9. セキュリティ考慮事項

### 9.1 RLS ポリシー検証

```sql
-- RLS ポリシーが正しく設定されているか確認
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual,
    with_check
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;
```

### 9.2 権限確認

```sql
-- テーブル権限確認
SELECT 
    table_name,
    privilege_type,
    grantee
FROM information_schema.table_privileges
WHERE table_schema = 'public'
ORDER BY table_name, privilege_type;
```

## 10. 移行とデプロイメント

### 10.1 マイグレーションスクリプト

```sql
-- マイグレーション実行順序
-- 1. テーブル作成
-- 2. インデックス作成
-- 3. RLS ポリシー設定
-- 4. トリガー作成
-- 5. ビュー作成
-- 6. 初期データ投入（必要に応じて）
```

### 10.2 ロールバック計画

```sql
-- ロールバック用スクリプト
-- 各マイグレーションに対応するロールバックスクリプトを準備
-- データバックアップの確認
-- 段階的ロールバックの実行
```

このデータベース設計により、セキュアでスケーラブルなシステムを構築できます。 