# 運用マニュアル

## 1. 概要

### 1.1 目的
本マニュアルは、システム設計アシスタントの運用担当者向けの運用手順書です。

### 1.2 対象読者
- システム管理者
- 運用担当者
- 技術サポート担当者

### 1.3 システム構成
- **フロントエンド**: Vercel (React 18 + TypeScript)
- **バックエンド**: Supabase (PostgreSQL + Auth + Realtime)
- **監視**: Vercel Analytics + Supabase Monitoring
- **CI/CD**: GitHub Actions

## 2. デプロイメント運用

### 2.1 本番環境へのデプロイ

#### 2.1.1 自動デプロイ（推奨）

1. **GitHubリポジトリにプッシュ**
   ```bash
   git add .
   git commit -m "Update: 機能追加・修正"
   git push origin main
   ```

2. **GitHub Actionsの確認**
   - GitHubリポジトリのActionsタブでCI/CDパイプラインの実行状況を確認
   - テストが成功したことを確認

3. **Vercelデプロイの確認**
   - Vercelダッシュボードでデプロイ状況を確認
   - デプロイが成功したことを確認

#### 2.1.2 手動デプロイ（緊急時）

1. **Vercelダッシュボードにアクセス**
   - https://vercel.com/dashboard

2. **プロジェクトを選択**
   - 対象プロジェクトをクリック

3. **手動デプロイを実行**
   - 「Deployments」タブで「Redeploy」をクリック

### 2.2 環境変数の管理

#### 2.2.1 環境変数の設定

1. **Vercelダッシュボードで環境変数を設定**
   ```
   VITE_SUPABASE_URL=https://your-project.supabase.co
   VITE_SUPABASE_ANON_KEY=your-anon-key
   VITE_SENTRY_DSN=your-sentry-dsn
   ```

2. **Supabase環境変数の確認**
   - Supabaseダッシュボードでプロジェクト設定を確認
   - APIキーが正しく設定されていることを確認

#### 2.2.2 環境変数の更新

1. **Vercelダッシュボードで環境変数を更新**
   - プロジェクト設定 → Environment Variables
   - 更新したい環境変数を編集

2. **デプロイを実行**
   - 環境変数更新後、再デプロイが必要

### 2.3 ロールバック手順

#### 2.3.1 緊急ロールバック

1. **Vercelダッシュボードでロールバック**
   - 「Deployments」タブで前のバージョンを選択
   - 「Redeploy」をクリック

2. **GitHubでロールバック**
   ```bash
   git revert HEAD
   git push origin main
   ```

## 3. 監視・監視運用

### 3.1 システム監視

#### 3.1.1 Vercel監視

1. **Vercel Analyticsの確認**
   - Vercelダッシュボード → Analytics
   - ページビュー、パフォーマンス、エラー率を確認

2. **パフォーマンス監視**
   - Core Web Vitalsの確認
   - 遅いページの特定と対応

#### 3.1.2 Supabase監視

1. **Supabaseダッシュボードの確認**
   - Database → Logs
   - エラーログ、スロークエリの確認

2. **リソース使用量の監視**
   - Database → Usage
   - ストレージ使用量、API使用量の確認

### 3.2 アラート設定

#### 3.2.1 アラートの確認

1. **Slack通知の確認**
   - セキュリティアラート
   - パフォーマンスアラート
   - エラーアラート

2. **メール通知の確認**
   - 重要なシステム通知
   - セキュリティインシデント

### 3.3 ログ監視

#### 3.3.1 ログの確認

1. **Vercelログの確認**
   ```bash
   vercel logs --follow
   ```

2. **Supabaseログの確認**
   - Supabaseダッシュボード → Database → Logs
   - リアルタイムログの確認

## 4. バックアップ・復旧

### 4.1 データベースバックアップ

#### 4.1.1 自動バックアップの確認

1. **Supabaseバックアップの確認**
   - Supabaseダッシュボード → Database → Backups
   - 最新のバックアップ日時を確認

2. **バックアップの手動実行**
   ```sql
   -- 手動バックアップの実行
   SELECT create_backup();
   ```

#### 4.1.2 バックアップの復元

1. **Supabaseダッシュボードで復元**
   - Database → Backups
   - 復元したいバックアップを選択
   - 「Restore」をクリック

### 4.2 ファイルバックアップ

#### 4.2.1 手動バックアップの実行

```bash
# バックアップスクリプトの実行
npm run backup

# バックアップファイルの確認
ls -la backups/
```

#### 4.2.2 バックアップの検証

1. **バックアップファイルの整合性確認**
   ```bash
   # JSONファイルの構文チェック
   jq . backups/latest/projects.json > /dev/null
   ```

2. **バックアップデータの確認**
   - バックアップファイルの内容を確認
   - 重要なデータが含まれていることを確認

## 5. 障害対応

### 5.1 障害検知

#### 5.1.1 障害の種類と対応

| 障害種別 | 検知方法 | 対応手順 |
|----------|----------|----------|
| アプリケーション停止 | ヘルスチェック失敗 | 1. ログ確認<br>2. 再起動<br>3. ロールバック |
| データベース接続エラー | アプリケーションエラー | 1. Supabase状態確認<br>2. 接続設定確認<br>3. サポート連絡 |
| 認証サービス停止 | ログインエラー | 1. Supabase Auth確認<br>2. 設定確認<br>3. サポート連絡 |

#### 5.1.2 緊急時連絡先

- **Supabaseサポート**: https://supabase.com/support
- **Vercelサポート**: https://vercel.com/support
- **システム管理者**: [管理者連絡先]

### 5.2 障害対応手順

#### 5.2.1 アプリケーション停止時の対応

1. **状況確認**
   ```bash
   # ヘルスチェック
   curl -f https://your-app.vercel.app/api/health
   
   # ログ確認
   vercel logs --follow
   ```

2. **原因特定**
   - エラーログの確認
   - 最近の変更の確認
   - 外部サービス状況の確認

3. **対応実行**
   - 設定修正
   - 再デプロイ
   - ロールバック

#### 5.2.2 データベース障害時の対応

1. **Supabase状況確認**
   - Supabaseダッシュボードでステータス確認
   - エラーログの確認

2. **接続確認**
   ```bash
   # データベース接続テスト
   psql "postgresql://postgres:[password]@db.[project].supabase.co:5432/postgres"
   ```

3. **復旧作業**
   - バックアップからの復元
   - 設定の修正

### 5.3 復旧後の確認

#### 5.3.1 機能確認

1. **基本機能の確認**
   - ログイン機能
   - プロジェクト一覧表示
   - タスク管理機能

2. **データ整合性の確認**
   - プロジェクトデータの確認
   - ユーザーデータの確認
   - 関連データの確認

#### 5.3.2 パフォーマンス確認

1. **レスポンス時間の確認**
   - ページ読み込み時間
   - API応答時間

2. **エラー率の確認**
   - エラーログの確認
   - ユーザー報告の確認

## 6. セキュリティ対応

### 6.1 セキュリティ監視

#### 6.1.1 セキュリティログの確認

1. **認証ログの確認**
   ```sql
   -- 異常なログイン試行の確認
   SELECT * FROM auth.audit_log_entries 
   WHERE created_at > NOW() - INTERVAL '24 hours'
   ORDER BY created_at DESC;
   ```

2. **アクセスログの確認**
   - Supabaseダッシュボード → Database → Logs
   - 異常なアクセスパターンの確認

#### 6.1.2 セキュリティアラートの対応

1. **アラートの確認**
   - Slack通知の確認
   - メール通知の確認

2. **対応手順**
   - 影響範囲の特定
   - 一時的な対策の実施
   - 根本原因の調査

### 6.2 セキュリティインシデント対応

#### 6.2.1 インシデント対応手順

1. **インシデントの検知**
   - セキュリティアラートの確認
   - 異常な活動の報告

2. **初期対応**
   - 影響範囲の特定
   - 一時的な対策の実施
   - 関係者への通知

3. **詳細調査**
   - ログの詳細分析
   - 原因の特定
   - 影響度の評価

4. **復旧作業**
   - セキュリティホールの修正
   - システムの復旧
   - データの復元

#### 6.2.2 報告・記録

1. **インシデントレポートの作成**
   - 発生時刻
   - 影響範囲
   - 対応内容
   - 再発防止策

2. **関係者への報告**
   - 経営陣への報告
   - ユーザーへの通知
   - 関係当局への報告（必要に応じて）

## 7. パフォーマンス最適化

### 7.1 パフォーマンス監視

#### 7.1.1 メトリクスの確認

1. **Vercel Analytics**
   - ページ読み込み時間
   - Core Web Vitals
   - エラー率

2. **Supabaseメトリクス**
   - データベース応答時間
   - クエリ実行時間
   - 接続数

#### 7.1.2 パフォーマンス改善

1. **フロントエンド最適化**
   - バンドルサイズの最適化
   - 画像の最適化
   - キャッシュの活用

2. **バックエンド最適化**
   - クエリの最適化
   - インデックスの追加
   - 接続プールの調整

### 7.2 スケーリング

#### 7.2.1 自動スケーリングの確認

1. **Vercel自動スケーリング**
   - トラフィックに応じた自動スケーリング
   - 設定の確認と調整

2. **Supabaseスケーリング**
   - データベースリソースの監視
   - 必要に応じたプラン変更

## 8. 定期メンテナンス

### 8.1 日次メンテナンス

#### 8.1.1 チェック項目

1. **システム状況の確認**
   - アプリケーションの稼働状況
   - データベースの稼働状況
   - エラーログの確認

2. **パフォーマンスの確認**
   - レスポンス時間
   - エラー率
   - リソース使用量

#### 8.1.2 対応作業

1. **ログの確認**
   - エラーログの分析
   - 警告ログの確認

2. **バックアップの確認**
   - 自動バックアップの成功確認
   - バックアップファイルの整合性確認

### 8.2 週次メンテナンス

#### 8.2.1 詳細分析

1. **パフォーマンス分析**
   - 週間のパフォーマンス傾向
   - ボトルネックの特定

2. **セキュリティ分析**
   - セキュリティログの分析
   - 異常な活動の確認

#### 8.2.2 最適化作業

1. **データベース最適化**
   - 不要なデータの削除
   - インデックスの最適化

2. **アプリケーション最適化**
   - コードの最適化
   - 設定の調整

### 8.3 月次メンテナンス

#### 8.3.1 包括的レビュー

1. **システム全体のレビュー**
   - パフォーマンスの総合評価
   - セキュリティの総合評価
   - 可用性の評価

2. **改善計画の策定**
   - パフォーマンス改善計画
   - セキュリティ強化計画
   - 機能拡張計画

#### 8.3.2 ドキュメント更新

1. **運用マニュアルの更新**
   - 手順の見直し
   - 新しい手順の追加

2. **設定ドキュメントの更新**
   - 設定変更の記録
   - ベストプラクティスの更新

## 9. 運用ツール

### 9.1 監視ツール

#### 9.1.1 Vercel監視

```bash
# Vercel CLIのインストール
npm i -g vercel

# ログの確認
vercel logs --follow

# デプロイ状況の確認
vercel ls
```

#### 9.1.2 Supabase監視

```bash
# Supabase CLIのインストール
npm install -g supabase

# プロジェクトの確認
supabase status

# ログの確認
supabase logs
```

### 9.2 運用スクリプト

#### 9.2.1 ヘルスチェックスクリプト

```bash
#!/bin/bash
# health-check.sh

URL="https://your-app.vercel.app/api/health"
RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" $URL)

if [ $RESPONSE -eq 200 ]; then
    echo "System is healthy"
    exit 0
else
    echo "System is unhealthy: HTTP $RESPONSE"
    exit 1
fi
```

#### 9.2.2 バックアップスクリプト

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="backups/$DATE"

mkdir -p $BACKUP_DIR

# データベースバックアップ
supabase db dump > $BACKUP_DIR/database.sql

# ファイルバックアップ
tar -czf $BACKUP_DIR/files.tar.gz public/

echo "Backup completed: $BACKUP_DIR"
```

## 10. 緊急時対応

### 10.1 緊急時連絡網

#### 10.1.1 連絡先一覧

| 役割 | 連絡先 | 対応時間 |
|------|--------|----------|
| システム管理者 | [管理者メール] | 24時間 |
| 運用担当者 | [運用メール] | 平日9-18時 |
| 技術サポート | [サポートメール] | 平日9-18時 |

#### 10.1.2 エスカレーション手順

1. **レベル1**: 運用担当者による対応
2. **レベル2**: システム管理者による対応
3. **レベル3**: 外部サポートによる対応

### 10.2 緊急時手順

#### 10.2.1 システム停止時の対応

1. **即座の対応**
   - 影響範囲の確認
   - ユーザーへの通知
   - 一時的な対策の実施

2. **復旧作業**
   - 原因の特定
   - 復旧作業の実行
   - 動作確認

3. **事後対応**
   - 再発防止策の実施
   - 報告書の作成
   - 関係者への報告

この運用マニュアルに従って、安定したシステム運用を行ってください。 