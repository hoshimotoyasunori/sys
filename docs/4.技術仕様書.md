# 技術仕様書

## 1. 技術スタック

### 1.1 フロントエンド
- **フレームワーク**: React 19.1.0
- **言語**: TypeScript 5.8.3
- **ビルドツール**: Vite 4.5.14
- **UIフレームワーク**: Tailwind CSS 3.4.17
- **コンポーネントライブラリ**: shadcn/ui
- **状態管理**: React Context API
- **ルーティング**: React Router DOM 6.30.1
- **デスクトップアプリ**: Electron 37.2.3

### 1.2 バックエンド
- **BaaS**: Supabase
- **データベース**: PostgreSQL 15
- **認証**: Supabase Auth
- **リアルタイム**: Supabase Realtime
- **ストレージ**: Supabase Storage
- **Edge Functions**: Deno

### 1.3 開発・運用
- **ホスティング**: Vercel
- **デスクトップアプリ**: Electron
- **バージョン管理**: Git
- **パッケージマネージャー**: npm
- **リンター**: ESLint
- **フォーマッター**: Prettier

## 2. 開発環境

### 2.1 必要なソフトウェア
- **Node.js**: 22.x以上
- **npm**: 8.0.0以上
- **Git**: 2.30.0以上
- **Supabase CLI**: 1.0.0以上

### 2.2 環境変数
```env
# Supabase設定
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# 開発環境
NODE_ENV=development
VITE_APP_ENV=development
```

### 2.3 開発サーバー
```bash
# Web開発サーバー起動
npm run dev

# Webビルド
npm run build

# Webプレビュー
npm run preview

# Electron開発
npm run electron:dev

# Electronビルド
npm run electron:build

# デスクトップアプリビルド
npm run build:mac    # macOS
npm run build:win    # Windows
npm run build:all    # 全プラットフォーム
```

## 3. プロジェクト構造

### 3.1 ディレクトリ構造
```
sys/
├── components/          # Reactコンポーネント
│   ├── ui/             # shadcn/uiコンポーネント
│   ├── Header.tsx      # ヘッダーコンポーネント
│   ├── MainApp.tsx     # メインアプリケーション
│   ├── ProjectSelector.tsx
│   ├── ProjectSwitcher.tsx
│   ├── InvitationAcceptPage.tsx
│   ├── TaskManager.tsx
│   ├── DeliverableTracker.tsx
│   ├── DocumentManager.tsx
│   ├── ProjectMembersDialog.tsx
│   ├── CreateProjectDialog.tsx
│   ├── DeleteProjectDialog.tsx
│   ├── ProjectSwitchDialog.tsx
│   ├── LoginForm.tsx
│   ├── AuthGuard.tsx
│   ├── DashboardLayout.tsx
│   ├── PhaseOverview.tsx
│   ├── AdvicePanel.tsx
│   ├── BasicGuide.tsx
│   ├── Templates.tsx
│   ├── RequirementsTemplate.tsx
│   ├── DownloadableTemplates.tsx
│   ├── DeliverablesChecklist.tsx
│   └── MobileApp.tsx
├── contexts/           # React Context
│   ├── AuthContext.tsx
│   ├── ProjectContext.tsx
│   ├── ProjectDataContext.tsx
│   └── ProjectMembersContext.tsx
├── lib/               # ユーティリティ
│   ├── supabase.ts    # Supabase設定
│   └── email.ts       # メール機能
├── supabase/          # Supabase設定
│   ├── migrations/    # データベースマイグレーション
│   ├── functions/     # Edge Functions
│   ├── config.toml    # Supabase設定
│   └── seed.sql       # 初期データ
├── styles/            # スタイルシート
│   └── globals.css
├── public/            # 静的ファイル
├── docs/              # ドキュメント
├── App.tsx            # メインアプリケーション
├── main.tsx           # エントリーポイント
├── electron-main.js   # Electronメインプロセス
├── package.json       # 依存関係
├── vite.config.ts     # Vite設定
├── tailwind.config.js # Tailwind設定
├── postcss.config.js  # PostCSS設定
├── tsconfig.json      # TypeScript設定
└── .env               # 環境変数
```

## 4. データベース設計

### 4.1 テーブル定義

#### 4.1.1 users (auth.users)
```sql
-- Supabase Authが管理するユーザーテーブル
-- 自動生成されるため、手動で作成しない
```

#### 4.1.2 projects
```sql
CREATE TABLE projects (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  created_by UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 4.1.3 project_members
```sql
CREATE TABLE project_members (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  role VARCHAR(20) NOT NULL DEFAULT 'member' CHECK (role IN ('owner', 'admin', 'member')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(project_id, user_id)
);
```

#### 4.1.4 project_invitations
```sql
CREATE TABLE project_invitations (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  email VARCHAR(255) NOT NULL,
  invited_by UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  status VARCHAR(20) NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'declined')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 4.1.5 phases
```sql
CREATE TABLE phases (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  order_index INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 4.1.6 tasks
```sql
CREATE TABLE tasks (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  phase_id UUID REFERENCES phases(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  is_completed BOOLEAN NOT NULL DEFAULT FALSE,
  order_index INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 4.1.7 deliverables
```sql
CREATE TABLE deliverables (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  phase_id UUID REFERENCES phases(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'not_started' CHECK (status IN ('not_started', 'in_progress', 'completed')),
  order_index INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 4.2 インデックス
```sql
-- パフォーマンス向上のためのインデックス
CREATE INDEX idx_project_members_project_id ON project_members(project_id);
CREATE INDEX idx_project_members_user_id ON project_members(user_id);
CREATE INDEX idx_project_invitations_project_id ON project_invitations(project_id);
CREATE INDEX idx_project_invitations_email ON project_invitations(email);
CREATE INDEX idx_phases_project_id ON phases(project_id);
CREATE INDEX idx_phases_order_index ON phases(order_index);
CREATE INDEX idx_tasks_phase_id ON tasks(phase_id);
CREATE INDEX idx_tasks_order_index ON tasks(order_index);
CREATE INDEX idx_deliverables_phase_id ON deliverables(phase_id);
CREATE INDEX idx_deliverables_order_index ON deliverables(order_index);
```

### 4.3 トリガー
```sql
-- 更新日時の自動更新
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_projects_updated_at BEFORE UPDATE ON projects
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_project_members_updated_at BEFORE UPDATE ON project_members
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_project_invitations_updated_at BEFORE UPDATE ON project_invitations
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_phases_updated_at BEFORE UPDATE ON phases
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_tasks_updated_at BEFORE UPDATE ON tasks
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_deliverables_updated_at BEFORE UPDATE ON deliverables
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 5. API設計

### 5.1 Supabaseクライアント設定
```typescript
// lib/supabase.ts
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);
```

### 5.2 データ型定義
```typescript
// プロジェクト
interface Project {
  id: string;
  name: string;
  description: string | null;
  created_by: string;
  created_at: string;
  updated_at: string;
}

// プロジェクトメンバー
interface ProjectMember {
  id: string;
  project_id: string;
  user_id: string;
  role: 'owner' | 'admin' | 'member';
  created_at: string;
  updated_at: string;
}

// プロジェクト招待
interface ProjectInvitation {
  id: string;
  project_id: string;
  email: string;
  invited_by: string;
  status: 'pending' | 'accepted' | 'declined';
  created_at: string;
  updated_at: string;
}

// フェーズ
interface Phase {
  id: string;
  project_id: string;
  name: string;
  order_index: number;
  created_at: string;
  updated_at: string;
}

// タスク
interface Task {
  id: string;
  phase_id: string;
  title: string;
  is_completed: boolean;
  order_index: number;
  created_at: string;
  updated_at: string;
}

// 成果物
interface Deliverable {
  id: string;
  phase_id: string;
  name: string;
  status: 'not_started' | 'in_progress' | 'completed';
  order_index: number;
  created_at: string;
  updated_at: string;
}
```

### 5.3 API関数
```typescript
// プロジェクト関連
export const createProject = async (name: string, description: string) => {
  const { data, error } = await supabase
    .from('projects')
    .insert([{ name, description }])
    .select()
    .single();
  
  if (error) throw error;
  return data;
};

export const getProjects = async () => {
  const { data, error } = await supabase
    .from('projects')
    .select('*')
    .order('created_at', { ascending: false });
  
  if (error) throw error;
  return data;
};

// タスク関連
export const updateTask = async (id: string, updates: Partial<Task>) => {
  const { data, error } = await supabase
    .from('tasks')
    .update(updates)
    .eq('id', id)
    .select()
    .single();
  
  if (error) throw error;
  return data;
};

// 成果物関連
export const updateDeliverable = async (id: string, updates: Partial<Deliverable>) => {
  const { data, error } = await supabase
    .from('deliverables')
    .update(updates)
    .eq('id', id)
    .select()
    .single();
  
  if (error) throw error;
  return data;
};
```

## 6. セキュリティ設計

### 6.1 Row Level Security (RLS)
```sql
-- RLSの有効化
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
ALTER TABLE project_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE project_invitations ENABLE ROW LEVEL SECURITY;
ALTER TABLE phases ENABLE ROW LEVEL SECURITY;
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE deliverables ENABLE ROW LEVEL SECURITY;

-- プロジェクトのRLSポリシー
CREATE POLICY "Users can view projects they are members of" ON projects
FOR ALL USING (
  auth.uid() IN (
    SELECT user_id FROM project_members WHERE project_id = id
  )
);

-- プロジェクトメンバーのRLSポリシー
CREATE POLICY "Users can view project members" ON project_members
FOR ALL USING (
  auth.uid() IN (
    SELECT user_id FROM project_members WHERE project_id = project_id
  )
);

-- タスクのRLSポリシー
CREATE POLICY "Users can view tasks" ON tasks
FOR ALL USING (
  auth.uid() IN (
    SELECT pm.user_id FROM project_members pm
    JOIN phases p ON p.project_id = pm.project_id
    WHERE p.id = phase_id
  )
);

-- 成果物のRLSポリシー
CREATE POLICY "Users can view deliverables" ON deliverables
FOR ALL USING (
  auth.uid() IN (
    SELECT pm.user_id FROM project_members pm
    JOIN phases p ON p.project_id = pm.project_id
    WHERE p.id = phase_id
  )
);
```

### 6.2 認証・認可
```typescript
// 認証状態の管理
export const useAuth = () => {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // 現在のセッションを取得
    supabase.auth.getSession().then(({ data: { session } }) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    // 認証状態の変更を監視
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (event, session) => {
        setUser(session?.user ?? null);
        setLoading(false);
      }
    );

    return () => subscription.unsubscribe();
  }, []);

  return { user, loading };
};
```

## 7. リアルタイム機能

### 7.1 Supabase Realtime設定
```typescript
// リアルタイム購読の設定
export const subscribeToProjectData = (projectId: string, callback: (payload: any) => void) => {
  const channel = supabase
    .channel(`project_${projectId}`)
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'tasks',
      filter: `phase_id=in.(SELECT id FROM phases WHERE project_id='${projectId}')`
    }, callback)
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'deliverables',
      filter: `phase_id=in.(SELECT id FROM phases WHERE project_id='${projectId}')`
    }, callback)
    .subscribe();

  return () => {
    supabase.removeChannel(channel);
  };
};
```

### 7.2 リアルタイム更新処理
```typescript
// リアルタイム更新の処理
useEffect(() => {
  if (!currentProject) return;

  const unsubscribe = subscribeToProjectData(currentProject.id, (payload) => {
    // データの更新処理
    if (payload.eventType === 'UPDATE') {
      if (payload.table === 'tasks') {
        setTasks(prev => prev.map(task => 
          task.id === payload.new.id ? payload.new : task
        ));
      } else if (payload.table === 'deliverables') {
        setDeliverables(prev => prev.map(deliverable => 
          deliverable.id === payload.new.id ? payload.new : deliverable
        ));
      }
    }
  });

  return unsubscribe;
}, [currentProject]);
```

## 8. エラーハンドリング

### 8.1 グローバルエラーハンドリング
```typescript
// エラーバウンダリー
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    console.error('Error caught by boundary:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return <div>エラーが発生しました。ページを再読み込みしてください。</div>;
    }

    return this.props.children;
  }
}
```

### 8.2 API エラーハンドリング
```typescript
// API エラーの統一処理
export const handleApiError = (error: any) => {
  console.error('API Error:', error);
  
  if (error.code === 'PGRST116') {
    return '認証エラーが発生しました。再度ログインしてください。';
  }
  
  if (error.code === 'PGRST301') {
    return '権限がありません。';
  }
  
  return 'エラーが発生しました。しばらく時間をおいて再度お試しください。';
};
```

## 9. パフォーマンス最適化

### 9.1 React最適化
```typescript
// メモ化による不要な再レンダリング防止
const TaskItem = React.memo(({ task, onToggle }: TaskItemProps) => {
  return (
    <div className="flex items-center space-x-2">
      <input
        type="checkbox"
        checked={task.is_completed}
        onChange={() => onToggle(task.id, !task.is_completed)}
      />
      <span className={task.is_completed ? 'line-through' : ''}>
        {task.title}
      </span>
    </div>
  );
});

// コールバックのメモ化
const handleTaskToggle = useCallback((taskId: string, completed: boolean) => {
  updateTask(taskId, { is_completed: completed });
}, []);
```

### 9.2 データ最適化
```typescript
// データの重複除去とソート
const deduplicateAndSort = <T extends { id: string; order_index: number }>(
  data: T[]
): T[] => {
  const unique = data.filter((item, index, self) => 
    index === self.findIndex(t => t.id === item.id)
  );
  return unique.sort((a, b) => a.order_index - b.order_index);
};
```

## 10. テスト設計

### 10.1 テスト環境設定
```json
// package.json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage"
  },
  "devDependencies": {
    "@testing-library/react": "^13.4.0",
    "@testing-library/jest-dom": "^5.16.5",
    "vitest": "^0.34.0",
    "jsdom": "^22.0.0"
  }
}
```

### 10.2 テスト例
```typescript
// コンポーネントテスト
import { render, screen, fireEvent } from '@testing-library/react';
import { TaskItem } from './TaskItem';

describe('TaskItem', () => {
  it('should render task title', () => {
    const task = {
      id: '1',
      title: 'テストタスク',
      is_completed: false,
      order_index: 0
    };
    
    render(<TaskItem task={task} onToggle={jest.fn()} />);
    expect(screen.getByText('テストタスク')).toBeInTheDocument();
  });

  it('should call onToggle when checkbox is clicked', () => {
    const task = {
      id: '1',
      title: 'テストタスク',
      is_completed: false,
      order_index: 0
    };
    const onToggle = jest.fn();
    
    render(<TaskItem task={task} onToggle={onToggle} />);
    fireEvent.click(screen.getByRole('checkbox'));
    
    expect(onToggle).toHaveBeenCalledWith('1', true);
  });
});
```

## 11. デプロイメント

### 11.1 Vercel設定
```json
// vercel.json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "framework": "vite",
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ]
}
```

### 11.2 環境変数設定
```env
# 本番環境
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
NODE_ENV=production
```

### 11.3 CI/CD設定
```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '22'
      - run: npm ci
      - run: npm run build
      - uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
```

## 12. Electron設定

### 12.1 Electronメインプロセス
```javascript
// electron-main.js
const { app, BrowserWindow } = require('electron');
const path = require('path');

function createWindow() {
  const mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      enableRemoteModule: false
    }
  });

  // 開発環境ではローカルサーバー、本番環境ではビルドファイルを読み込み
  if (process.env.NODE_ENV === 'development') {
    mainWindow.loadURL('http://localhost:5173');
    mainWindow.webContents.openDevTools();
  } else {
    mainWindow.loadFile(path.join(__dirname, 'dist', 'index.html'));
  }
}

app.whenReady().then(createWindow);

app.on('window-all-closed', () => {
  if (process.platform !== 'darwin') {
    app.quit();
  }
});

app.on('activate', () => {
  if (BrowserWindow.getAllWindows().length === 0) {
    createWindow();
  }
});
```

### 12.2 Electronビルド設定
```json
// package.json の build セクション
{
  "build": {
    "appId": "com.yourcompany.sys",
    "productName": "システム設計アシスタント",
    "files": [
      "dist/**/*",
      "electron-main.js",
      "package.json"
    ],
    "directories": {
      "buildResources": "build"
    },
    "mac": {
      "target": "dmg"
    },
    "win": {
      "target": "nsis"
    }
  }
}
```

### 12.3 セキュリティ設定
- **nodeIntegration**: false（無効化）
- **contextIsolation**: true（有効化）
- **enableRemoteModule**: false（無効化）
- **CSP**: Content Security Policyの適用

## 13. 監視・ログ

### 13.1 ログ設定
```typescript
// ログユーティリティ
export const logger = {
  info: (message: string, data?: any) => {
    console.log(`[INFO] ${message}`, data);
  },
  error: (message: string, error?: any) => {
    console.error(`[ERROR] ${message}`, error);
  },
  warn: (message: string, data?: any) => {
    console.warn(`[WARN] ${message}`, data);
  }
};
```

### 12.2 パフォーマンス監視
```typescript
// パフォーマンス監視
export const measurePerformance = (name: string, fn: () => void) => {
  const start = performance.now();
  fn();
  const end = performance.now();
  console.log(`${name} took ${end - start} milliseconds`);
};
``` 