# 表形式データフロー図

## システム概要

| 項目 | 説明 |
|------|------|
| **システム名** | システム設計アシスタント |
| **アーキテクチャ** | マルチクライアント同期システム |
| **バックエンド** | Supabase (PostgreSQL + リアルタイム) |
| **フロントエンド** | React + TypeScript |
| **デスクトップ** | Electron |
| **モバイル** | React Native / PWA |
| **ウェブ** | React + Service Worker |

## クライアント端末比較

| 機能 | デスクトップアプリ | モバイルアプリ | ウェブアプリ |
|------|-------------------|---------------|-------------|
| **プラットフォーム** | Electron | React Native | ブラウザ |
| **オフライン対応** | ローカルキャッシュ | ローカルキャッシュ | Service Worker |
| **同期方式** | WebSocket + API | WebSocket + API | WebSocket + API |
| **通知** | システム通知 | プッシュ通知 | ブラウザ通知 |
| **ファイル操作** | ネイティブ | ネイティブ | ブラウザAPI |
| **パフォーマンス** | 最高 | 高 | 中 |
| **インストール** | 必要 | 必要 | 不要 |

## データフロー詳細

### 1. 認証フロー

| ステップ | デスクトップ | モバイル | ウェブ | バックエンド |
|----------|-------------|----------|-------|-------------|
| **1. ログイン** | Electron認証 | ネイティブ認証 | ブラウザ認証 | Supabase Auth |
| **2. トークン取得** | JWT保存 | JWT保存 | JWT保存 | JWT発行 |
| **3. セッション管理** | ローカル保存 | セキュアストレージ | セッションストレージ | セッション追跡 |

### 2. データ同期フロー

| 操作 | クライアント側 | ネットワーク | サーバー側 | 結果 |
|------|---------------|-------------|-----------|------|
| **データ更新** | ローカル変更 | HTTPS API | データベース更新 | 成功レスポンス |
| **リアルタイム通知** | WebSocket受信 | WebSocket | 変更通知送信 | 他クライアント更新 |
| **競合解決** | 競合検出 | 同期リクエスト | バージョン管理 | マージ完了 |
| **オフライン同期** | キュー保存 | 接続復旧時 | 一括処理 | 同期完了 |

### 3. ファイル管理フロー

| 操作 | クライアント | ストレージ | 処理 |
|------|-------------|-----------|------|
| **アップロード** | ファイル選択 | Supabase Storage | 保存 + URL生成 |
| **ダウンロード** | ダウンロード要求 | ファイル取得 | ローカル保存 |
| **共有** | 共有リンク生成 | アクセス権設定 | 他ユーザー通知 |

## ネットワーク通信

### API通信

| エンドポイント | メソッド | 認証 | 用途 |
|---------------|----------|------|------|
| `/api/projects` | GET/POST/PUT/DELETE | JWT | プロジェクト管理 |
| `/api/tasks` | GET/POST/PUT/DELETE | JWT | タスク管理 |
| `/api/deliverables` | GET/POST/PUT/DELETE | JWT | 成果物管理 |
| `/api/members` | GET/POST/PUT/DELETE | JWT | メンバー管理 |
| `/api/sync` | POST | JWT | データ同期 |

### WebSocket通信

| チャンネル | イベント | 送信者 | 受信者 |
|-----------|----------|--------|--------|
| `project:{id}` | `update` | サーバー | 全クライアント |
| `project:{id}` | `member_join` | サーバー | プロジェクトメンバー |
| `project:{id}` | `task_complete` | サーバー | プロジェクトメンバー |
| `user:{id}` | `notification` | サーバー | 特定ユーザー |

## セキュリティ対策

| 層 | 対策 | 実装 |
|----|------|------|
| **認証** | JWT + リフレッシュトークン | Supabase Auth |
| **認可** | Row Level Security | PostgreSQL RLS |
| **通信** | HTTPS + WSS | TLS 1.3 |
| **入力検証** | バリデーション | Zod + サーバーサイド |
| **XSS対策** | CSP + サニタイゼーション | React + DOMPurify |
| **CSRF対策** | SameSite Cookie | ブラウザ設定 |

## パフォーマンス最適化

| 最適化 | 実装方法 | 効果 |
|--------|----------|------|
| **コード分割** | React.lazy + Suspense | 初期ロード時間短縮 |
| **キャッシュ** | React Query + SWR | API呼び出し削減 |
| **CDN** | Vercel Edge Network | 静的ファイル配信高速化 |
| **データベース** | インデックス + クエリ最適化 | レスポンス時間短縮 |
| **画像最適化** | WebP + レスポンシブ | 帯域幅削減 |

## エラーハンドリング

| エラー種別 | クライアント側 | サーバー側 | 復旧方法 |
|-----------|---------------|-----------|----------|
| **ネットワークエラー** | リトライ + オフライン表示 | ログ記録 | 接続復旧時自動同期 |
| **認証エラー** | ログイン画面表示 | セッション無効化 | 再ログイン |
| **データ競合** | 競合解決UI | バージョン管理 | 手動マージ |
| **サーバーエラー** | エラーメッセージ表示 | ログ記録 + 監視 | 自動復旧 |

## 監視・ログ

| 項目 | 収集データ | 用途 |
|------|------------|------|
| **パフォーマンス** | レスポンス時間、エラー率 | 最適化 |
| **ユーザー行動** | ページビュー、操作ログ | UX改善 |
| **システム状態** | CPU、メモリ、ディスク使用量 | リソース管理 |
| **セキュリティ** | 認証失敗、不正アクセス | セキュリティ監視 |

## 運用・保守

| 作業 | 頻度 | 内容 |
|------|------|------|
| **バックアップ** | 日次 | データベース + ファイル |
| **セキュリティ更新** | 月次 | 依存関係 + セキュリティパッチ |
| **パフォーマンス監視** | 常時 | リアルタイム監視 |
| **ユーザーサポート** | 随時 | 問い合わせ対応 | 